; tox.ini file for Tox https://tox.wiki/en/latest/config.html

; To perform the same tests done in GitHub Actions by CI-CD but locally (i.e. before pushing), run $ tox --parallel

; At its core tox provides a convenient way to run arbitrary commands in isolated environments to serve as a single
; entry point for build, test and release activities.

; May be run in parallel:
; > tox -p


;  #### REMINDER: will not work if UV_SYSTEM_PYTHON is set!
; PS > Remove-Item Env:\UV_SYSTEM_PYTHON && tox -p
; > set UV_SYSTEM_PYTHON= && tox

[tox]
requires =
    packaging >= 25.0
    tox >= 4.30.1
    tox-uv >= 1.28.0
env_list =
    pre-commit
    py{313,310}-new-install  # We install it for the current and lowest version we support
    py{313,312,311,310}-pytest
    post
skip_missing_interpreters = true
; Seed the testing environment with essential packaging tools. 
uv_seed = true
package = wheel

[testenv]
; Settings defined here are automatically inherited by individual environments unless overridden
; To run a single environment: > tox -e py313-pytest
set_env =
    PRE_COMMIT_COLOR = always
    PYTEST_ADDOPTS = --color=yes
    PYTHONPATH = {toxinidir}
    PYTHONUTF8 = 1
parallel_show_output = true


[testenv:pre-commit]
; Settings defined in the top-level testenv section are automatically inherited if not overwritten
; temp_dir = {work_dir}/.tmp_pre-commit
deps =
    -rtests/requirements_pre-commit.txt
temp_dir = {work_dir}/.tmp_pre-commit
skip_install = true
description = Run pre-commit
commands =
    pre-commit autoupdate
    pre-commit run --all-files --show-diff-on-failure

[testenv:new-install]
; Settings defined in the top-level testenv section are automatically inherited if not overwritten
; Empty values are to remove (override) top level
description = Emulate a new installation using wheel, ensuring e.g. that all packages are installed
commands =
    python -m build -w
    uv pip install --upgrade --find-links={toxinidir}\dist airportsdata

[testenv:pytest]
; Settings defined in the top-level testenv section are automatically inherited if not overwritten
allowlist_externals = pytest
deps =
    -rtests/requirements_testing.txt
description = Run tests
commands = pytest -v --cov=./ tests/


[testenv:post]
description = Post-tests cleanup for coverage
depends =
    py{313,312,311,310}-pytest
skip_install = true
deps =
    coverage
    coverage-conditional-plugin
commands =
    coverage combine
    ; TODO The command below works in Windows only
    coverage html
    cmd /c if %errorlevel% equ 0 start "" "file://{toxinidir}/post/htmlcov/index.html"
allowlist_externals =
    cmd
